# Opus Advanced - 長對話管理與進階功能
version: 1.0.0

trigger: 對話輪數 > 20 時詢問「是否啟用進度追蹤模式？」後載入

---

## RoadMap 同步提醒

當偵測到以下情況時，**主動提醒**用戶更新 RoadMap 與相關文件：

- 對話超過 **20 輪**，或偵測到大量功能變更
- 新增功能 → 可能需要新增對應 skill
- 刪除功能 → 可能可以移除不需要的 skill
- 架構調整 → 可能需要更新 `docs/Architecture.md`

## 對話開始建議

新對話開始時，若涉及功能開發，建議先讀 `docs/` 下的核心文件（RoadMap、Architecture），確認上下文一致。

---

## 自動里程碑追蹤

每完成以下任一條件，主動輸出進度摘要：
- 完成 3 個功能點
- 修復 5 個 bug
- 變更超過 10 個檔案
- 對話超過 20 輪

---

## 進度摘要格式

```markdown
📊 進度摘要（第 N 輪）

✅ 已完成模組：
   - 用戶管理：新增註冊功能（commit: a1b2c3 | 測試: ✅ | 文件: ✅）
   - API 整合：串接第三方支付（commit: d4e5f6 | 測試: ✅ | 文件: ⏳）

🔄 進行中：
   - OAuth 登入：預計完成時間 1/20，需確認 Google API Key

⏭️ 待處理（優先順序）：
   1. [P0 - 緊急] 修復支付失敗未回滾問題
   2. [P1 - 高優先] 實作用戶權限管理
   3. [P2 - 中優先] 優化首頁載入速度

⚠️ 阻塞項：
   - Google OAuth 需等待 API Key 核准

📈 整體進度：
   - RoadMap 完成度：65% (13/20 功能)
   - 測試覆蓋率：72%
   - 技術債務：3 項（見 docs/TechnicalDebt.md）

💡 建議下一步：
   優先修復 P0 問題，避免影響用戶付款流程
```

---

## 上下文恢復機制

對話中斷後重新開始時，主動詢問：

```markdown
👋 歡迎回來！

上次對話：2024-01-15 14:30
最後任務：實作用戶權限管理
狀態：進行中（已完成 Role 定義，待實作權限檢查）

❓ 需要我總結上次進度嗎？
1. 是，請總結上次所有進度
2. 否，直接繼續
3. 只告訴我待處理事項
```

---

## 架構決策記錄 (ADR)

重大技術決策時，自動建立 `docs/ADR-YYYYMMDD-<主題>.md`

### 觸發條件
- 選擇資料庫系統（PostgreSQL vs MySQL vs MongoDB）
- 選擇框架/函式庫（影響專案結構）
- 選擇部署方案（Docker vs Kubernetes vs Serverless）
- 選擇認證/授權機制（JWT vs Session vs OAuth）
- 重大效能優化策略

### ADR 結構

```markdown
# ADR-20240115-選擇 PostgreSQL 作為資料庫

## 狀態
已採用

## 情境
需要選擇關聯式資料庫，候選方案為 PostgreSQL 與 MySQL

## 決策
選擇 PostgreSQL 15.x

## 理由
1. 支援更豐富的資料類型（JSON, Array, UUID）
2. 更強的 ACID 保證
3. 團隊有使用經驗
4. 免費且開源

## 後果
### 正面
- 可使用 JSONB 欄位減少 JOIN
- 全文搜尋功能內建

### 負面
- 部署複雜度略高於 MySQL
- 學習曲線較陡（若團隊不熟悉）

## 替代方案
- **MySQL**：更簡單的部署，但功能較少
- **MongoDB**：彈性 Schema，但不適合複雜關聯查詢

## 驗證方式
- 執行壓力測試（1000 並發）
- 查詢效能 < 100ms
```

---

## 技術債務追蹤

當發現需要「妥協」的實作時，記錄於 `docs/TechnicalDebt.md`：

```markdown
# 技術債務追蹤

## [P1 - 高優先] 用戶頭像上傳未實作檔案大小限制
- 建立時間：2024-01-15
- 負責人：Alice
- 影響範圍：用戶管理模組
- 風險：可能遭受 DoS 攻擊（上傳巨大檔案）
- 理想實作：
  - 前端限制 5MB
  - 後端驗證檔案大小與類型
  - 使用 CDN 儲存
- 預估工時：2 小時
- 預計解決：2024-01-20

## [P2 - 中優先] 登入頁未實作 Rate Limiting
- 建立時間：2024-01-10
- 負責人：Bob
- 影響範圍：認證模組
- 風險：可能遭受暴力破解攻擊
- 理想實作：
  - 15 分鐘內最多 5 次嘗試
  - 失敗 3 次後顯示驗證碼
- 預估工時：3 小時
- 預計解決：2024-01-22

## [P3 - 低優先] 首頁圖片未使用 WebP 格式
- 建立時間：2024-01-12
- 負責人：Charlie
- 影響範圍：首頁效能
- 風險：載入速度較慢（約 2.5s）
- 理想實作：
  - 使用 WebP 格式
  - 實作 lazy loading
- 預估工時：1 小時
- 預計解決：2024-01-25
```

---

## 對話摘要壓縮

當對話超過 30 輪時，自動壓縮歷史：

```markdown
🗜️ 對話摘要（第 1-30 輪）

### 主要成就
- 建立專案結構（Next.js + PostgreSQL + Docker）
- 實作用戶註冊與登入功能
- 串接 Stripe 支付 API
- 部署至 Vercel 測試環境

### 遇到的問題與解決方案
1. **問題**：Docker 容器啟動失敗
   **解決**：修正 docker-compose.yml 中的環境變數設定

2. **問題**：Stripe Webhook 驗證失敗
   **解決**：使用原始請求 body 進行驗證

### 待辦事項
- [ ] 實作用戶權限管理
- [ ] 優化首頁載入速度
- [ ] 撰寫 API 文件

### 重要決策
- 選擇 PostgreSQL（見 ADR-20240115）
- 使用 JWT 進行認證（見 ADR-20240116）

### 技術債務
3 項（見 docs/TechnicalDebt.md）

---

📌 後續對話將基於此摘要，歷史細節已歸檔
```

---

## 專案健康度評估

每 50 輪對話輸出一次專案健康度報告：

```markdown
🏥 專案健康度報告

### 整體評分：B+ (85/100)

### 各項指標

#### 📝 文件完整度：90/100 ✅
- [x] README.md
- [x] API.md
- [x] Deployment.md
- [ ] 缺少架構圖

#### 🧪 測試覆蓋率：72/100 ⚠️
- 單元測試：65%（建議 ≥70%）
- 整合測試：30%（建議 ≥30%）
- E2E 測試：10%（建議 ≥10%）
- **建議**：提升核心業務邏輯的單元測試覆蓋率

#### 🔒 安全性：88/100 ✅
- [x] 敏感資料放 .env
- [x] 使用參數化查詢
- [ ] 缺少 Rate Limiting
- [ ] 缺少 CSP Header

#### ⚡ 效能：80/100 ⚠️
- API P95：450ms（目標 <500ms）✅
- FCP：1.8s（目標 <1.5s）⚠️
- **建議**：優化首頁載入速度（程式碼分割）

#### 🛠️ 技術債務：75/100 ⚠️
- 3 項技術債務待處理
- 最舊債務：10 天前
- **建議**：每週至少解決 1 項技術債務

### 建議優先處理
1. 提升單元測試覆蓋率至 70%
2. 實作 Rate Limiting 防止暴力破解
3. 優化首頁 FCP 至 1.5s 以下
```

---

## 回顧與反思

重大功能完成後，引導進行回顧：

```markdown
🎯 功能回顧：用戶管理模組

### 目標達成度
- [x] 用戶註冊
- [x] 登入/登出
- [x] 密碼重設
- [ ] 雙因素認證（延後實作）

### 做得好的地方
✅ 測試覆蓋率達 85%
✅ API 文件完整
✅ 錯誤處理完善

### 可改進之處
⚠️ 註冊流程略複雜（4 個步驟）
⚠️ Email 驗證信可能進垃圾郵件

### 學到的教訓
💡 先實作核心功能，再擴充進階功能
💡 測試先行能減少後期 bug

### 下次可以更好
- 使用 OAuth 減少自建認證的複雜度
- 實作註冊流程的使用者測試

### 技術債務
1 項：雙因素認證延後實作（P2 優先度）
```

---

## 啟用方式

### 自動啟用
對話超過 20 輪時，自動詢問：

```
📊 偵測到長對話（已進行 23 輪）

❓ 是否啟用「進度追蹤模式」？
1. 是，啟用（自動產生進度摘要）
2. 否，繼續正常對話
```

### 手動啟用
任何時候都可以說：
- 「啟用進度追蹤」
- 「總結目前進度」
- 「產生專案健康度報告」

---

**原則**：長對話不應該失焦。透過結構化摘要與追蹤，確保專案始終朝目標前進。