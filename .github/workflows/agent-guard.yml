# GitHub Action: Agent Guard
# è‡ªå‹•æƒæ .agent/ ç›®éŒ„ä¸‹çš„æ‰€æœ‰ skill/workflow æª”æ¡ˆ
# ç¢ºä¿æ²’æœ‰æƒ¡æ„æŒ‡ä»¤è¢«å¼•å…¥

name: Agent Guard

on:
  push:
    paths:
      - '.agent/**'
  pull_request:
    paths:
      - '.agent/**'
  workflow_dispatch:

jobs:
  scan-skills:
    name: ğŸ”’ Scan Agent Skills
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Security Scan
        run: |
          echo "ğŸ” æƒæ .agent/ ç›®éŒ„ä¸‹çš„æ‰€æœ‰ Markdown æª”æ¡ˆ..."
          
          ERRORS=0
          
          # å±éšªé—œéµå­—æ¸…å–®
          DANGEROUS_PATTERNS=(
            "rm -rf"
            "mkfs"
            "dd if="
            "curl.*|.*bash"
            "wget.*|.*sh"
            "nc -e"
            "bash -i"
            "> /dev/sda"
            "chmod 777"
            "eval("
            "exec("
            "__import__"
          )
          
          # æƒææ‰€æœ‰ .md æª”æ¡ˆ (æ’é™¤æ ¸å¿ƒè¦å‰‡èˆ‡æ‰‹å†Šé¿å…èª¤å ±)
          EXCLUDE_LIST=("skill-acquisition.skill.md" "skill-acquisition.md" "security.skill.md" "user_rules.md" "performance.skill.md" "UxSoul-extractor.skill.md")
          FIND_CMD="find .agent -name \"*.md\" -type f"
          for item in "${EXCLUDE_LIST[@]}"; do
            FIND_CMD="$FIND_CMD | grep -v \"$item\""
          done
          
          for file in $(eval $FIND_CMD); do
            echo "ğŸ“„ æƒæï¼š$file"
            
            for pattern in "${DANGEROUS_PATTERNS[@]}"; do
              if grep -l "$pattern" "$file" 2>/dev/null; then
                echo "ğŸš¨ ç™¼ç¾å±éšªæ¨¡å¼ '$pattern' åœ¨ $file"
                ERRORS=$((ERRORS + 1))
              fi
            done
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "âŒ ç™¼ç¾ $ERRORS å€‹æ½›åœ¨å®‰å…¨å•é¡Œï¼"
            echo "è«‹æª¢æŸ¥ä¸Šè¿°æª”æ¡ˆä¸¦ç§»é™¤å±éšªæŒ‡ä»¤ã€‚"
            exit 1
          else
            echo ""
            echo "âœ… å®‰å…¨æƒæé€šéï¼"
          fi

  verify-structure:
    name: ğŸ“ Verify Agent Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Required Files
        run: |
          echo "ğŸ“‹ æª¢æŸ¥å¿…è¦æª”æ¡ˆçµæ§‹..."
          
          REQUIRED_DIRS=(
            ".agent/skills"
            ".agent/workflows"
          )
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir å­˜åœ¨"
            else
              echo "âš ï¸ $dir ä¸å­˜åœ¨"
            fi
          done

      - name: Validate Frontmatter
        run: |
          echo "ğŸ“ é©—è­‰ YAML frontmatter..."
          
          for file in $(find .agent -name "*.md" -type f); do
            # æª¢æŸ¥æ˜¯å¦æœ‰ version æ¬„ä½
            if head -20 "$file" | grep -q "^version:"; then
              echo "âœ… $file æœ‰ç‰ˆæœ¬è™Ÿ"
            else
              echo "âš ï¸ $file ç¼ºå°‘ç‰ˆæœ¬è™Ÿ"
            fi
          done
