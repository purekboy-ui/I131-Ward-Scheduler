# GitHub Action: Publish Extension (All Markets)
# è‡ªå‹•ç™¼å¸ƒ VS Code Extension åˆ°æ‰€æœ‰å¸‚å ´
#
# è§¸ç™¼æ™‚æ©Ÿï¼š
#   - å»ºç«‹ GitHub Release
#   - push tagï¼ˆæ ¼å¼ï¼šv*ï¼Œä¾‹å¦‚ v7.9.0ï¼‰
#   - æ‰‹å‹•è§¸ç™¼ï¼ˆå¯é¸æ“‡æ˜¯å¦ç™¼å¸ƒåˆ° Marketplaceï¼‰
#
# ç™¼å¸ƒç›®æ¨™ï¼š
#   1. VS Code Marketplaceï¼ˆMicrosoftï¼‰â†’ éœ€è¦ VSCE_PAT secret
#   2. Open VSX Registryï¼ˆEclipse/Gitpodï¼‰â†’ éœ€è¦ OVSX_PAT secret
#
# å‰ç½®æ¢ä»¶ï¼ˆå¿…é ˆå…ˆè¨­å®š GitHub Secretsï¼‰ï¼š
#   - VSCE_PATï¼šVS Code Marketplace Personal Access Token
#   - OVSX_PATï¼šOpen VSX Registry Personal Access Token
#
# åŒ…å«æ­¥é©Ÿï¼š
#   1. å®‰å…¨æŽƒæï¼ˆé˜²æ­¢å±éšªæŒ‡ä»¤è¢«ç™¼å¸ƒï¼‰
#   2. ç‰ˆæœ¬è™Ÿä¸€è‡´æ€§é©—è­‰ï¼ˆtag vs package.jsonï¼‰
#   3. Extension ç·¨è­¯èˆ‡å¥å…¨æ€§æª¢æŸ¥
#   4. WebUI å»ºç½®ï¼ˆæ³¨å…¥åˆ° extension/out/webviewï¼‰
#   5. æ‰“åŒ… VSIX
#   6. ä¸Šå‚³ Artifact + é™„åŠ åˆ° Release
#   7. ç™¼å¸ƒåˆ° VS Code Marketplace
#   8. ç™¼å¸ƒåˆ° Open VSX Registry
#   9. è¼¸å‡ºç™¼å¸ƒç‹€æ…‹æ‘˜è¦

name: Publish Extension (All Markets)

on:
  release:
    types: [created]
  push:
    tags:
      - 'v*'
    paths-ignore:
      - 'docs/**'
      - '.agent/logs/**'
      - '**.md'
  workflow_dispatch:
    inputs:
      publish_market:
        description: 'æ˜¯å¦ç™¼å¸ƒåˆ° Marketplace'
        required: true
        type: boolean
        default: true

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # å®‰å…¨æŽƒæï¼šåƒ…æŽƒæå¯åŸ·è¡Œç¨‹å¼ç¢¼ï¼ˆæŽ’é™¤ç¯„æœ¬/UI èªªæ˜Žæ–‡å­—ï¼‰
      - name: Security Scan for Dangerous Commands
        run: |
          echo "ðŸ” åŸ·è¡Œå®‰å…¨æŽƒæ..."
          # åƒ…æŽƒæ .ts/.js/.sh ç­‰å¯åŸ·è¡Œæª”ï¼ŒæŽ’é™¤ç¯„æœ¬ã€UIã€æ–‡ä»¶èˆ‡ç¬¬ä¸‰æ–¹ç›®éŒ„
          # ä½¿ç”¨ || true æ•æ‰ grep exit code 1 (æœªæ‰¾åˆ°)
          MATCHES=$(grep -r -E "rm -rf" . \
            --include='*.ts' --include='*.js' --include='*.sh' \
            --exclude-dir=.git --exclude-dir=node_modules \
            --exclude-dir=.github --exclude-dir=.agent \
            --exclude-dir=assets \
            --exclude=pre-commit --exclude=project_context.json \
            || true)
          
          if [ -n "$MATCHES" ]; then
            echo "ðŸš¨ è­¦å‘Š: ç™¼ç¾ 'rm -rf' æŒ‡ä»¤ï¼"
            echo "$MATCHES"
            echo "::error title=Security Scan Failed::ç™¼ç¾æ½›åœ¨å®‰å…¨å•é¡Œ: rm -rf"
            exit 1
          else
            echo "âœ… å®‰å…¨æŽƒæé€šéŽï¼"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Cache WebUI dependencies
        uses: actions/cache@v4
        with:
          path: webui/node_modules
          key: ${{ runner.os }}-webui-${{ hashFiles('webui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-webui-

      # Sync Docs & Assets (Single Source of Truth)
      - name: Sync Docs & Assets
        run: |
          echo "ðŸ“‚ Current Directory Layout:"
          ls -la
          
          echo "ðŸ“„ Syncing README & CHANGELOG..."
          # ç¢ºä¿ç›®æ¨™ç›®éŒ„å­˜åœ¨
          mkdir -p vscode-extension
          
          if [ -f "README.md" ]; then
            cp -v README.md vscode-extension/
          else
            echo "âŒ Error: README.md not found in root!"
            exit 1
          fi
          
          if [ -f "CHANGELOG.md" ]; then
            cp -v CHANGELOG.md vscode-extension/
          else
             echo "âš ï¸ Warning: CHANGELOG.md not found!"
          fi
          
          echo "ðŸ–¼ï¸ Syncing Images..."
          mkdir -p vscode-extension/docs/images
          if [ -d "docs/images" ]; then
            cp -r docs/images/* vscode-extension/docs/images/
          fi
          
          echo "âœ… Sync Completed!"

      - name: Get Version
        id: get_version
        run: |
          VERSION=$(node -p "require('./vscode-extension/package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Verify Version Consistency
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PKG_VERSION=${{ steps.get_version.outputs.VERSION }}
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "âŒ Version Mismatch! Tag: $TAG_VERSION, Package: $PKG_VERSION"
            echo "Please ensure package.json version matches the git tag."
            exit 1
          fi
          echo "âœ… Version Verified: $PKG_VERSION"

      # 1. Build Extension First (Ensure 'out' dir exists)
      - name: Install, Compile & Smoke Check Extension
        working-directory: ./vscode-extension
        run: |
          npm ci
          npm run compile
          npm run smoke:deps

      # 2. Build WebUI (Injects into extension/out/webview)
      - name: Install & Build WebUI
        working-directory: ./webui
        run: |
          npm ci
          npm run build

      # 3. Package Extension
      - name: Package Extension
        working-directory: ./vscode-extension
        run: |
          # CLEANUP: Ensure no stale .vsix files exist from previous failed runs or caching
          rm -f *.vsix
          npm run package

      # 4. Upload Artifacts & Release Assets
      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pixiu-agent-${{ steps.get_version.outputs.VERSION }}
          path: ./vscode-extension/*.vsix
          retention-days: 5

      - name: Attach to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ./vscode-extension/*.vsix
          generate_release_notes: true

      # 5. Publish to VS Code Marketplace (Microsoft)
      - name: Publish to VS Code Marketplace
        id: publish_vscode
        working-directory: ./vscode-extension
        run: |
          npx @vscode/vsce publish -p ${{ secrets.VSCE_PAT }} --packagePath *.vsix
          echo "VSCODE_STATUS=âœ… ç™¼å¸ƒæˆåŠŸ" >> $GITHUB_ENV
        continue-on-error: true
      
      # Handle failure for VS Code
      - name: Check VS Code Status
        if: steps.publish_vscode.outcome == 'failure'
        run: echo "VSCODE_STATUS=âŒ ç™¼å¸ƒå¤±æ•—" >> $GITHUB_ENV

      # 6. Publish to Open VSX (Eclipse)
      - name: Publish to Open VSX
        id: publish_openvsx
        working-directory: ./vscode-extension
        run: |
          npx ovsx publish *.vsix -p ${{ secrets.OVSX_PAT }}
          echo "OPENVSX_STATUS=âœ… ç™¼å¸ƒæˆåŠŸ" >> $GITHUB_ENV
        continue-on-error: true

      # Handle failure for Open VSX
      - name: Check Open VSX Status
        if: steps.publish_openvsx.outcome == 'failure'
        run: echo "OPENVSX_STATUS=âŒ ç™¼å¸ƒå¤±æ•—" >> $GITHUB_ENV

      # 7. Generate Summary
      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ ç™¼å¸ƒç‹€æ…‹å ±å‘Š (v${{ steps.get_version.outputs.VERSION }})" >> $GITHUB_STEP_SUMMARY
          echo "| ç™¼å¸ƒå¹³å° (Registry) | ç‹€æ…‹ (Status) |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Microsoft Marketplace** | ${{ env.VSCODE_STATUS }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Open VSX Registry** | ${{ env.OPENVSX_STATUS }} |" >> $GITHUB_STEP_SUMMARY
